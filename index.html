<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Testing the oscope</title>
    <style type="text/css">
      @import url(style.css);
    </style>
  </head>
  <body>
    <div id='body'>
    <h1>oscope.js</h1>
    <h2>Visualisation of real-time time-series</h2>
    <h3>Select chart type:</h3>
    <select name="select-plot-type" onchange="context.type(this.value)">
      <option value="scrolling">Scrolling</option>
      <option value="sweeping" selected>Sweeping</option>
    </select>
    <div id='example1'></div>
    <div id='example2'></div>
    <div id='example3'></div>
    <script src='d3.js'></script>
    <script src='ts.js'></script>
    <script src='d3-tip.js'></script>
    <script src='oscope.js'></script>
    <script>
      function random( name, dt ){
        var values = ts.timeSeries(),
            i = 0,
            value = 0,
            next;
        if( dt === undefined ){
          dt = 1000;
        }
        return context.metric( function(start, stop, step, callback){
          start = +start; stop = +stop;
          if( isNaN(next) ) next = start;
          values.dropDataBefore(start);
          while( next < stop ){
            value = Math.max(-10, Math.min(10, value + .8 * Math.random() - .4 + .2 * Math.cos(i += .2)));
            values.insert(next, value);
            next += dt;
          }
          callback( null, values );
        }, name);
      }
      function sinusoid( name, f, dt ){
        var values = ts.timeSeries(),
            value = 0,
            phase = 0.0,
            next;
        if( dt === undefined ){
          dt = 1000;
        }
        if( f === undefined ){
          f = 1.0;
        }
        return context.metric( function(start, stop, step, callback){
          start = +start; stop = +stop;
          if( isNaN(next) ) next = start;
          values.dropDataBefore(start);
          while( next < stop ){
            value = 8.0 * Math.cos(phase);
            phase += 2.0*Math.PI*f*dt/1000;
            values.insert(next, value);
            next += dt;
          }
          callback( null, values );
        }, name);
      }

      function randomAnnotation( name, dt ){
        var annotationOpen = false,
        values = [],
        avgPeriod = 10,
        annoFormat = d3.time.format( '%H:%M:%S' );

        if( dt === undefined ) dt = 1000;

        return context.annotation( function( start, stop, callback ){
          var toggle = Math.round(avgPeriod*1000/dt * Math.random()) == 0;

          if( toggle ){
            if( annotationOpen ){
              avgPeriod = 10;
              values[ values.length-1 ].endTime = stop;
              values[ values.length-1 ].longText += '.<br> Duration: ' +
                (stop - values[ values.length-1].startTime)/1000;
              annotationOpen = false;
            }
            else{
              avgPeriod = 1;
              values.push( { 'startTime':stop, 'endTime':0, 'shortText':'Annotation',
                'longText':'Generated at ' + annoFormat( stop ) } );
              annotationOpen = true;
            }
          }
          callback( null, values );
        }, name );
      }


    </script>
    <script type="text/javascript">
      var screenUpdateStep = 1000/10, // ms
          serverDelay = 0,
          clientDelay = 200,
          overlap = 5000, // 2500, // ms overlap in the plot
          plotDuration = 30000, //60000 // ms
          extent = [-30, 30],
          margin = { top: 10, left: 50, bottom: 10, right: 50 },
          width = 800,
          height = 120,
          valueWidth = 50,
          myInnerWidth,
          myInnerHeight;

      myInnerWidth = width - margin.left - margin.right;
      myInnerHeight = height - margin.top - margin.bottom;

      var context = oscope.context()
            .serverDelay(serverDelay)
            .clientDelay(clientDelay)
            .step(screenUpdateStep) // 100 ms
            .size(myInnerWidth)
            .overlap( overlap )
            .duration(plotDuration);



      var xGridGenerator = d3.svg.axis()
        .scale( context.scale )
        .orient( 'top' )
        .innerTickSize(-myInnerHeight)
        .tickFormat('');

      var foo = random('foo', 50),
        bar = sinusoid('bar', 0.1, 100),
        baz = random('baz', 200),
        anno = randomAnnotation( 'Annotations', 200 );

        d3.select('#example1').call( function(div){

        var tAxis = div.append('div')
          .attr('class', 'axis')
          .attr( 'width', width )
          .call(context.axis().orient('top'));

        // Move the svg over a bit to acount for the left margin
        tAxis.select( 'svg' )
            .attr( 'width', width )
            .select( 'g' )
              .attr( 'transform', 'translate(' + margin.left + ',27)' );

        var yScale = d3.scale.linear()
          .domain(extent)
          .range([myInnerHeight,0]);

        var yAxis = d3.svg.axis()
          .scale(yScale)
          .orient('left')
          .ticks(5)
          .tickValues([-30, -20, -10, 0, 10, 20, 30])
          .tickFormat( function( d ){
            return ( d === -20 ? 'baz' : (d === 0 ? 'bar' :
              ( d === 20 ? 'foo' : null ) ) );
          })
          .innerTickSize(-myInnerWidth);


        var theOscope = div.selectAll('oscope')
          .data([[foo,bar,baz]])
          //.data( [bar] )
          .enter().append('div')
          .attr('class','oscope')
          .style( 'width', width + 'px' )
          .style( 'height', height + 'px' )
          .call(context.oscope().extent(extent).height(myInnerHeight)
          .barWidth(50)
          .format(d3.format( '4.1f' ) ) );


        // Position the canvas
        theOscope.select('canvas')
          .style( 'width', myInnerWidth + 'px' )
          .style( 'height', myInnerHeight + 'px')
          .style( 'top', margin.top + 'px' )
          .style( 'left', margin.left + 'px' );

        // Don't display the title
        theOscope.selectAll('.title')
        .style( 'display', 'none' );

        // Adjust the top of the values
        theOscope.selectAll('.value')
          .style( 'margin-top', margin.top + 'px' );

        var svgOverlay = theOscope.append('svg')
          .style('height',height+'px')
          .style('position','absolute')
          .style('overflow','visible')
          .style('z-index',-1)
          .attr( 'width', width )
          .attr( 'height', height );

        svgOverlay.append('g')
        .attr('class','yaxis')
        .attr('transform','translate(' +  ( margin.left ) +','
              + margin.top + ')' )
              .call(yAxis);

        svgOverlay.append('g')
        .attr('class', 'xgrid')
        .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')' )
        .call( xGridGenerator );

        div.append('div')
        .attr('class', 'rule')
          .call(context.rule());
      });


      d3.select( '#example2' ).call( function(div){

        extent = [-10,10];

        yScale = d3.scale.linear()
          .domain(extent)
          .range([myInnerHeight,0]);

        yAxis = d3.svg.axis()
          .scale(yScale)
          .orient('left')
          .ticks(5)
          .innerTickSize(-myInnerWidth);


        theOscope = div.selectAll('oscope')
          .data( [foo] )
          .enter().append('div')
            .attr('class','oscope')
            .style( 'width', width + 'px' )
            .style( 'height', height + 'px' )
            .call(context.oscope().extent(extent).height(myInnerHeight)
            .barWidth(50)
            .format(d3.format( '4.1f' ) ) );

        theOscope.select('canvas')
          .style( 'width', myInnerWidth + 'px' )
          .style( 'height', myInnerHeight + 'px')
          .style( 'top', margin.top + 'px' )
          .style( 'left', margin.left + 'px' );

        // Adjust the top of the title
        theOscope.selectAll('.title')
          .style( 'margin-top', margin.top + 'px' );

        // Adjust the top of the values
        theOscope.selectAll('.value')
          .style( 'margin-top', margin.top + 'px' );

        svgOverlay = theOscope.append('svg')
          .style('height',height+'px')
          .style('position','absolute')
          .style('overflow','visible')
          .style('z-index',-1)
          .attr( 'width', width )
          .attr( 'height', height );

        svgOverlay.append('g')
        .attr('class','yaxis')
        .attr('transform','translate(' +  margin.left +','
              + margin.top + ')' )
          .call(yAxis);

        svgOverlay.append('g')
        .attr('class', 'xgrid')
        .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')' )
        .call( xGridGenerator );

      });


      d3.select( '#example3' ).call( function(div){
        var theAnnote = div.selectAll('annote')
        .data([anno])
        .enter().append('div')
          .attr('class', 'annote' )
          .style( 'width', width + 'px' )
          .style( 'height', '30px' )
          .call(context.annote() );

        var annoSvg = theAnnote.select( 'svg' )
          .attr( 'width', width )
          .select( 'g' )
            .attr( 'transform', 'translate(' + margin.left +',0)' );

        var tip = d3.tip()
                      .attr( 'class', 'd3-tip' )
                      .direction( 's' )
                      .offset( [10, 0] )
                      .html( function(d){ return '<span>' + d.longText + '</span>'; } );

        annoSvg.call( tip );

        // Make sure that every annotation has a tooltip:
        context.on( 'change.tooltip', function( start, stop ){
          // Get all the annotation rectangles:
          annoSvg.selectAll( '.annotations rect')
              .on( 'mouseover', tip.show )
              .on( 'mouseout', tip.hide );

        });
      });


      // On mousemove, reposition the chart values to match the rule.
      context.on("focus", function(i) {
      d3.selectAll(".value").style("right", i == null ? null :  width - margin.left - i - valueWidth + "px");
      });

    </script>

  </body>
</html>

